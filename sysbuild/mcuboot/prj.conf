# MCUBoot configuration for nRF5340 with external flash and rollback support
# Disable size optimizations to avoid potential alignment issues
CONFIG_SIZE_OPTIMIZATIONS=n
CONFIG_SPEED_OPTIMIZATIONS=y
CONFIG_KERNEL_BIN_NAME="mcuboot"

CONFIG_MULTITHREADING=y
# External flash configuration
CONFIG_NORDIC_QSPI_NOR=y
CONFIG_NORDIC_QSPI_NOR_STACK_WRITE_BUFFER_SIZE=256
CONFIG_PM_OVERRIDE_EXTERNAL_DRIVER_CHECK=y
CONFIG_FLASH=y
CONFIG_MPU_ALLOW_FLASH_WRITE=y

# MCUboot specific
CONFIG_BOOT_MAX_IMG_SECTORS=2048
CONFIG_PM_PARTITION_SIZE_MCUBOOT=0x20000

# Flash operations
CONFIG_FLASH_MAP=y
CONFIG_FLASH_MAP_LABELS=y

# Ensure slot0 validation is disabled
CONFIG_BOOT_VALIDATE_SLOT0=n

# Enable watchdog feed during boot
CONFIG_BOOT_WATCHDOG_FEED=n

# Enable reset after successful update
CONFIG_REBOOT=y

# Build output
CONFIG_BUILD_OUTPUT_HEX=y

CONFIG_PM_EXTERNAL_FLASH_MCUBOOT_SECONDARY=y

# Safety configurations for external flash
CONFIG_MULTITHREADING=y
CONFIG_MAIN_STACK_SIZE=10240
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=2048

# Enable proper error handling
CONFIG_BOOT_ERASE_PROGRESSIVELY=y
CONFIG_BOOT_IMAGE_ACCESS_HOOKS=y

# Fix for SHA256 alignment issues with QSPI
CONFIG_MBEDTLS_SHA256_SMALLER=y

# Ensure QSPI is properly initialized
CONFIG_NORDIC_QSPI_NOR_INIT_PRIORITY=40


CONFIG_NORDIC_QSPI_NOR_FLASH_LAYOUT_PAGE_SIZE=4096


# Enable heap for dynamic allocations
CONFIG_HEAP_MEM_POOL_SIZE=8192

# Increase ISR stack for interrupt handling
CONFIG_ISR_STACK_SIZE=4096