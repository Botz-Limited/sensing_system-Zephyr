# MCUboot board-specific configuration for nRF5340DK
# This file is automatically included when building for nrf5340dk_nrf5340_cpuapp

# Multi-image updates require upgrade-only mode
CONFIG_BOOT_UPGRADE_ONLY=y

# External flash configuration
CONFIG_NORDIC_QSPI_NOR=y
CONFIG_NORDIC_QSPI_NOR_FLASH_LAYOUT_PAGE_SIZE=4096
CONFIG_NORDIC_QSPI_NOR_STACK_WRITE_BUFFER_SIZE=256

# The network core cannot access external flash directly. The flash simulator must be used to
# allow MCUboot to transfer the network core update image from the external flash to the network
# core flash memory.
CONFIG_FLASH_SIMULATOR=y
CONFIG_FLASH_SIMULATOR_DOUBLE_WRITES=y
CONFIG_FLASH_SIMULATOR_STATS=n

# Enable MCUboot logging for debugging
CONFIG_LOG=y
CONFIG_MCUBOOT_LOG_LEVEL_INF=y

# Increase stack size for SHA256 operations
CONFIG_MAIN_STACK_SIZE=10240

# Enable hardware accelerated crypto if available
CONFIG_HW_CC3XX=y

# Additional fixes for QSPI flash access after FOTA
# Ensure proper alignment for flash reads
CONFIG_FLASH_LOAD_OFFSET=0x10000
CONFIG_FLASH_LOAD_SIZE=0x40000

# Enable proper synchronization
CONFIG_MULTITHREADING=y

# Ensure QSPI is ready before accessing
CONFIG_NORDIC_QSPI_NOR_INIT_PRIORITY=40

# Ensure flash simulator uses proper alignment
CONFIG_FLASH_SIMULATOR_UNALIGNED_READ=n

# Enable debugging to help diagnose issues
CONFIG_DEBUG=y
CONFIG_BOOT_BANNER=y

# Ensure sufficient heap for mbedTLS operations
CONFIG_MBEDTLS_HEAP_SIZE=8192

# Disable PSA crypto to use traditional mbedTLS
CONFIG_MBEDTLS_USE_PSA_CRYPTO=n

# Use smaller SHA256 implementation
CONFIG_MBEDTLS_SHA256_SMALLER=y

# Ensure proper initialization order
CONFIG_FLASH_INIT_PRIORITY=40